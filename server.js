const express = require('express');
const mongoose = require('mongoose');
const bcrypt = require("bcrypt");
const session = require('express-session');

const app = express();
const PORT = 3000;

// Set EJS as the view engine
app.set('view engine', 'ejs');
app.set('views', __dirname + '/views'); // Set the views directory

/**
 * Middleware to parse JSON and handle sessions, and URL-encoded data parsing.
 * This middleware is used to parse incoming JSON requests and manage user sessions.
 * Generated by ChatGPT -4o
 *
 * @author https://chat.openai.com/
 */
// Middleware to parse JSON
app.use(express.json());

// Middleware to parse URL-encoded form data
app.use(express.urlencoded({ extended: true }));

// Middleware for sessions
app.use(session({
    secret: 'your-secret-key',
    resave: false,
    saveUninitialized: true,
    cookie: { maxAge: 86400000 }
}));
// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


// Database connection
mongoose.connect('mongodb://localhost:27017', {

    /** 
     * Setting's for database connection
     * With these settings, we can avoid deprecation warnings and ensure a more stable connection.
     * Generated by ChatGPT -4o
     * 
     * @author https://chat.openai.com/
     */
    useNewUrlParser: true,
    useUnifiedTopology: true,
    // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

}).then(() => {
    console.log('Connected to database successfully!');
}).catch((err) => {
    console.log('Error connecting to database:', err.message);
});

/** This is the schema for users, it acts as a template for models to use when creating new documents in the database.
 *  Transaction ID's are included in the user schema.
 *  Pets are included in the user schema.
 */
const userSchema = new mongoose.Schema({
    username: String,
    password: String,
    balance: Number,
    transactions: Array,
    owned: Array,
    pet: String,
    date: Date
});

/**
 * This is the schema for transactions, it acts as a template for models to use when creating new documents in the database.
 * Transactions are tied to users in there user schema by thier model ID.
 * The server automatically adds the transaction ID to the user schema when a new transaction is created.
 */
const transactionSchema = new mongoose.Schema({
    name: String,
    category: String,
    date: Date,
    amount: Number,
    comments: String
});

// Here we create a model for the user schema, this will be used to make our collection in the database.
const users = mongoose.model('users', userSchema);

// Here we create a model for the transaction schema, this will be used to make our collection in the database.
const transactions = mongoose.model('transactions', transactionSchema);

// Redirect / to /login, in the event that only the base URL is entered in the browser.
// This redirects the user to the home page if they are logged in.
app.get('/', (request, result) => {
    if (request.session.uid) {
        return result.redirect('/home');
    }
    result.redirect('/index');
});

// Here the server will recognise that the server is requested with the /login URL and will render the login file.
// If the user is already logged in, they will be redirected to the home page.
app.get('/login', (request, result) => {
    if (request.session.uid) {
        return result.redirect('/home');
    }
    result.render('login');
});

app.get('/game', (request, result) => {
    if (!request.session.uid) {
        return result.redirect('/home');
    }
    result.render('game');
});

app.get('/profile', (request, result) => {
    if (!request.session.uid) {
        return result.redirect('/login');
    }
    result.render('profile');
});

// Here the server will recognise that the server is requested with the /home URL and will render the home file.
// If the user is not logged in, they will be redirected to the login page.
app.get('/home', (request, result) => {
    if (!request.session.uid) {
        return result.redirect('/login');
    }
    result.render('home', { username: request.session.username });
});

// Here the server will recognise that the server is requested with the /index URL and will render the index file.
// If the user is already logged in, they will be redirected to the home page.
app.get('/index', (request, result) => {
    if (request.session.uid) {
        return result.redirect('/home');
    }
    result.render('index');
});

/**
 * Sign's up a new user.
 * If the user already exists, an error message is returned.
 * Uses bcrypt to hash the password before saving it to the database.
 * The new user is saved to the database and their uid is stored in the session.
 * The user is created from the mongoDB users model.
 */
app.post('/auth/register', async (request, result) => {
    try {
        const username = request.body.username;
        const password = request.body.password;
        const existingUser = await users.findOne({ username });
        if (existingUser) {
            return result.status(400).json({ error: 'Username already exists' });
        }
        const hashedPassword = await bcrypt.hash(password, 10);
        const newUser = new users({
            username,
            password: hashedPassword,
            balance: 0,
            transactions: [],
            owned: [],
            pet: null,
            date: new Date()
        });
        await newUser.save();
        request.session.uid = newUser._id;
        request.session.username = newUser.username;
        result.redirect('/home');
    } catch (err) {
        console.log('Error during registration:', err.message);
        result.status(500).json({ error: 'Internal server error' });
    }
});

/**
 * Log's in a user.
 * If the user does not exist, an error message is returned.
 * The password is compared to the hashed password in the database using bcrypt.
 * If the password is correct, the user's uid is stored in the session.
 * If the password is incorrect, an error message is returned.
 * The user is redirected to the home page upon successful login.
 */
app.post('/auth/login', async (request, result) => {
    try {
        const { username, password } = request.body;
        const user = await users.findOne({ username });
        if (!user) {
            return result.status(401).json({ error: 'Invalid username or password' });
        }
        const isMatch = await bcrypt.compare(password, user.password);
        if (!isMatch) {
            return result.status(401).json({ error: 'Invalid username or password' });
        }
        request.session.uid = user._id;
        request.session.username = user.username;
        result.redirect('/home');
    } catch (err) {
        console.log('Error during login:', err.message);
        result.status(500).json({ error: err.message });
    }
});

/*
 * Log's out a user.
 * The session is destroyed and the user is redirected to the login page.
 * If there is an error during logout, an error message is returned.
 * The user is redirected to the login page upon successful logout.
 */
app.post('/auth/logout', (request, result) => {
    request.session.destroy(err => {
        if (err) {
            return result.status(500).json({ error: 'Failed to log out:' + err.message });
        }
        result.redirect('/login');
    });
});

/**
 * Add's a new transaction.
 * The transaction is created from the mongoDB transactions model.
 * The transaction is saved to the database and the user's transactions array is updated automatically with the models ID.
 */
app.post('/transaction/add', (request, result) => {
    const name = request.body.name;
    const category = request.body.category;
    const date = request.body.date;
    const amount = request.body.amount;
    const comments = request.body.comments; 
    const newTransaction = new transactions({
        name,
        category,
        date,
        amount,
        comments
    });
    newTransaction.save()
        .then(() => {
            return users.findByIdAndUpdate(request.session.uid, { $push: { transactions: newTransaction._id } });
        })
        .then(() => {
            console.log('Transaction added successfully to: ', request.session.uid, '! Details: ', newTransaction);
            result.redirect('/home');
        })
        .catch(err => {
            console.log('Error adding transaction:', err.message);
            result.status(500).json({ error: 'Internal server error' });
        });
});

// Start's the server and listens on the specified port.
// The port is set to 3000 by default.
app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});